<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lavagna Pollosa!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #1a1a1c;
            --surface: #2a2a2e;
            --surface2: #323236;
            --border: rgba(255,255,255,0.08);
            --text: rgba(255,255,255,0.85);
            --text-dim: rgba(255,255,255,0.35);
        }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg);
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        /* ── TOP BAR (palette) ── */
        #topbar {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 100px;
            padding: 8px 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .color-swatch {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.15s, border-color 0.15s;
            flex-shrink: 0;
        }
        .color-swatch:hover { transform: scale(1.18); }
        .color-swatch.active {
            border-color: rgba(255,255,255,0.85);
            transform: scale(1.18);
        }
        .color-divider {
            width: 1px; height: 20px;
            background: var(--border);
            margin: 0 2px;
        }

        /* ── CANVAS ── */
        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            cursor: crosshair;
            touch-action: none;
        }
        body.erasing #canvas { cursor: cell; }

        /* ── BOTTOM TOOLBAR ── */
        #toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 100px;
            padding: 10px 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .tb-group { display: flex; align-items: center; gap: 2px; }
        .tb-divider { width: 1px; height: 28px; background: var(--border); margin: 0 8px; }

        /* Size buttons */
        .size-btn {
            background: none; border: none; cursor: pointer;
            width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-dim);
            transition: background 0.15s, color 0.15s;
        }
        .size-btn:hover { background: var(--surface2); color: var(--text); }
        .size-btn.active { background: var(--surface2); color: var(--text); }
        .size-btn .dot { background: currentColor; border-radius: 50%; }

        /* Tool buttons */
        .tool-btn {
            background: none; border: none; cursor: pointer;
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-dim);
            transition: background 0.15s, color 0.15s;
        }
        .tool-btn:hover { background: var(--surface2); color: var(--text); }
        .tool-btn.active { background: rgba(255,255,255,0.12); color: #fff; }
        .tool-btn svg {
            width: 20px; height: 20px;
            stroke: currentColor; stroke-width: 1.8;
            fill: none; stroke-linecap: round; stroke-linejoin: round;
        }

        /* Action buttons */
        .act-btn {
            background: none; border: none; cursor: pointer;
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-dim);
            transition: background 0.15s, color 0.15s;
        }
        .act-btn:hover { background: var(--surface2); color: var(--text); }
        .act-btn:disabled { opacity: 0.25; pointer-events: none; }
        .act-btn svg {
            width: 20px; height: 20px;
            stroke: currentColor; stroke-width: 1.8;
            fill: none; stroke-linecap: round; stroke-linejoin: round;
        }
        .touch-btn.active { color: #60a5fa; background: rgba(96,165,250,0.12); }

        /* ── TOP RIGHT CORNER ── */
        #corner-btns {
            position: fixed;
            top: 16px; right: 16px;
            z-index: 100;
            display: flex; align-items: center; gap: 4px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 6px 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .corner-btn {
            background: none; border: none; cursor: pointer;
            width: 36px; height: 36px; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            color: var(--text-dim);
            transition: background 0.15s, color 0.15s;
        }
        .corner-btn:hover { background: var(--surface2); color: var(--text); }
        .corner-btn svg {
            width: 18px; height: 18px;
            stroke: currentColor; stroke-width: 1.8;
            fill: none; stroke-linecap: round; stroke-linejoin: round;
        }
        .corner-divider { width: 1px; height: 20px; background: var(--border); margin: 0 2px; }
    </style>
</head>
<body>

<!-- COLOR PALETTE -->
<div id="topbar">
    <div class="color-swatch active" data-color="#ff453a" style="background:#ff453a" title="Rosso"></div>
    <div class="color-swatch" data-color="#ff9f0a" style="background:#ff9f0a" title="Arancio"></div>
    <div class="color-swatch" data-color="#ffd60a" style="background:#ffd60a" title="Giallo"></div>
    <div class="color-swatch" data-color="#30d158" style="background:#30d158" title="Verde"></div>
    <div class="color-swatch" data-color="#0a84ff" style="background:#0a84ff" title="Blu"></div>
    <div class="color-swatch" data-color="#636366" style="background:#636366" title="Grigio scuro"></div>
    <div class="color-swatch" data-color="#aeaeb2" style="background:#aeaeb2" title="Grigio chiaro"></div>
    <div class="color-divider"></div>
    <div class="color-swatch" data-color="#ffffff" style="background:#ffffff" title="Bianco"></div>
</div>

<!-- CANVAS -->
<canvas id="canvas"></canvas>

<!-- TOP RIGHT -->
<div id="corner-btns">
    <button class="corner-btn" id="clearBtn" title="Cancella tutto (⌘K)">
        <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
    </button>
    <div class="corner-divider"></div>
    <button class="corner-btn" id="saveBtn" title="Salva (⌘S)">
        <svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
    </button>
</div>

<!-- BOTTOM TOOLBAR -->
<div id="toolbar">
    <!-- Brush sizes -->
    <div class="tb-group">
        <button class="size-btn" data-size="3" title="Piccolo (1)">
            <div class="dot" style="width:5px;height:5px"></div>
        </button>
        <button class="size-btn active" data-size="8" title="Medio (2)">
            <div class="dot" style="width:9px;height:9px"></div>
        </button>
        <button class="size-btn" data-size="20" title="Grande (3)">
            <div class="dot" style="width:16px;height:16px"></div>
        </button>
    </div>

    <div class="tb-divider"></div>

    <!-- Drawing tools -->
    <div class="tb-group">
        <button class="tool-btn active" data-tool="pen" title="Penna (P)">
            <svg viewBox="0 0 24 24"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
        </button>
        <button class="tool-btn" data-tool="line" title="Linea (L)">
            <svg viewBox="0 0 24 24"><line x1="5" y1="19" x2="19" y2="5"/></svg>
        </button>
        <button class="tool-btn" data-tool="arrow" title="Freccia (A)">
            <svg viewBox="0 0 24 24"><line x1="5" y1="19" x2="19" y2="5"/><polyline points="10 5 19 5 19 14"/></svg>
        </button>
        <button class="tool-btn" data-tool="ellipse" title="Ellisse (O)">
            <svg viewBox="0 0 24 24"><ellipse cx="12" cy="12" rx="10" ry="7"/></svg>
        </button>
        <button class="tool-btn" data-tool="rect" title="Rettangolo (R)">
            <svg viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="12" rx="2"/></svg>
        </button>
        <button class="tool-btn" data-tool="eraser" title="Gomma (E)">
            <svg viewBox="0 0 24 24"><path d="M20 20H7L3 16l10-10 7 7-3.5 3.5"/><line x1="6" y1="11" x2="13" y2="18"/></svg>
        </button>
    </div>

    <div class="tb-divider"></div>

    <!-- Undo / Redo / Touch -->
    <div class="tb-group">
        <button class="act-btn" id="undoBtn" title="Annulla (⌘Z)" disabled>
            <svg viewBox="0 0 24 24"><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></svg>
        </button>
        <button class="act-btn" id="redoBtn" title="Ripeti (⌘⇧Z)" disabled>
            <svg viewBox="0 0 24 24"><polyline points="15 14 20 9 15 4"/><path d="M4 20v-7a4 4 0 0 1 4-4h12"/></svg>
        </button>
        <button class="act-btn touch-btn" id="touchBtn" title="Blocca touch / solo stilo">
            <svg viewBox="0 0 24 24"><path d="M18 11V6a2 2 0 0 0-2-2 2 2 0 0 0-2 2"/><path d="M14 10V4a2 2 0 0 0-2-2 2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2 2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>
        </button>
    </div>
</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

let currentColor = '#ff453a';
let brushSize = 8;
let currentTool = 'pen';
let isDrawing = false;
let touchMode = false;

let startX = 0, startY = 0, lastX = 0, lastY = 0;
let snapshot = null;

const undoStack = [], redoStack = [];
const MAX_HISTORY = 50;

// ── Canvas setup ──────────────────────────────────────────────────────
function resizeCanvas() {
    const imgData = (canvas.width > 0 && canvas.height > 0)
        ? ctx.getImageData(0, 0, canvas.width, canvas.height) : null;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    fillBg();
    if (imgData) ctx.putImageData(imgData, 0, 0);
    applyStyle();
}

function fillBg() {
    ctx.fillStyle = '#1a1a1c';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function applyStyle() {
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = currentTool === 'eraser' ? '#1a1a1c' : currentColor;
    ctx.lineWidth = brushSize;
}

// ── History ───────────────────────────────────────────────────────────
function saveHistory() {
    undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
    if (undoStack.length > MAX_HISTORY) undoStack.shift();
    redoStack.length = 0;
    updateHistoryBtns();
}

function undo() {
    if (!undoStack.length) return;
    redoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
    ctx.putImageData(undoStack.pop(), 0, 0);
    updateHistoryBtns();
}

function redo() {
    if (!redoStack.length) return;
    undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
    ctx.putImageData(redoStack.pop(), 0, 0);
    updateHistoryBtns();
}

function updateHistoryBtns() {
    document.getElementById('undoBtn').disabled = !undoStack.length;
    document.getElementById('redoBtn').disabled = !redoStack.length;
}

// ── Coordinates ───────────────────────────────────────────────────────
function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const sx = canvas.width / rect.width;
    const sy = canvas.height / rect.height;
    const src = e.touches ? e.touches[0] : e;
    return { x: (src.clientX - rect.left) * sx, y: (src.clientY - rect.top) * sy };
}

// ── Shape preview ─────────────────────────────────────────────────────
function drawShapePreview(x, y) {
    ctx.putImageData(snapshot, 0, 0);
    applyStyle();
    ctx.beginPath();
    if (currentTool === 'line') {
        ctx.moveTo(startX, startY); ctx.lineTo(x, y); ctx.stroke();
    } else if (currentTool === 'arrow') {
        const angle = Math.atan2(y - startY, x - startX);
        const hl = Math.max(14, brushSize * 3);
        ctx.moveTo(startX, startY); ctx.lineTo(x, y); ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x - hl * Math.cos(angle - Math.PI/6), y - hl * Math.sin(angle - Math.PI/6));
        ctx.moveTo(x, y);
        ctx.lineTo(x - hl * Math.cos(angle + Math.PI/6), y - hl * Math.sin(angle + Math.PI/6));
        ctx.stroke();
    } else if (currentTool === 'ellipse') {
        const rx = Math.abs(x - startX) / 2, ry = Math.abs(y - startY) / 2;
        ctx.ellipse(startX + (x-startX)/2, startY + (y-startY)/2, Math.max(rx,1), Math.max(ry,1), 0, 0, Math.PI*2);
        ctx.stroke();
    } else if (currentTool === 'rect') {
        ctx.roundRect(startX, startY, x - startX, y - startY, 6);
        ctx.stroke();
    }
}

// ── Pointer events ────────────────────────────────────────────────────
function isIgnored(e) {
    return touchMode && e.pointerType === 'touch';
}

canvas.addEventListener('pointerdown', e => {
    if (isIgnored(e)) return;
    e.preventDefault();
    saveHistory();
    const p = getPos(e);
    startX = lastX = p.x; startY = lastY = p.y;
    isDrawing = true;
    applyStyle();

    if (['line','arrow','ellipse','rect'].includes(currentTool)) {
        snapshot = ctx.getImageData(0, 0, canvas.width, canvas.height);
    } else {
        ctx.beginPath();
        ctx.arc(p.x, p.y, brushSize / 2, 0, Math.PI * 2);
        ctx.fillStyle = currentTool === 'eraser' ? '#1a1a1c' : currentColor;
        ctx.fill();
    }
    canvas.setPointerCapture(e.pointerId);
});

canvas.addEventListener('pointermove', e => {
    if (!isDrawing || isIgnored(e)) return;
    e.preventDefault();
    const p = getPos(e);
    applyStyle();
    if (['line','arrow','ellipse','rect'].includes(currentTool)) {
        drawShapePreview(p.x, p.y);
    } else {
        ctx.beginPath();
        ctx.moveTo(lastX, lastY); ctx.lineTo(p.x, p.y);
        ctx.stroke();
        lastX = p.x; lastY = p.y;
    }
});

canvas.addEventListener('pointerup', () => { isDrawing = false; snapshot = null; ctx.beginPath(); });
canvas.addEventListener('pointercancel', () => { isDrawing = false; snapshot = null; });

// ── Color swatches ────────────────────────────────────────────────────
document.querySelectorAll('.color-swatch').forEach(sw => {
    sw.addEventListener('click', () => {
        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
        sw.classList.add('active');
        currentColor = sw.dataset.color;
        if (currentTool === 'eraser') setTool('pen');
        applyStyle();
    });
});

// ── Tool selection ────────────────────────────────────────────────────
function setTool(tool) {
    currentTool = tool;
    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
    const btn = document.querySelector(`[data-tool="${tool}"]`);
    if (btn) btn.classList.add('active');
    document.body.classList.toggle('erasing', tool === 'eraser');
    applyStyle();
}

document.querySelectorAll('.tool-btn').forEach(btn =>
    btn.addEventListener('click', () => setTool(btn.dataset.tool)));

// ── Size selection ────────────────────────────────────────────────────
document.querySelectorAll('.size-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        brushSize = parseInt(btn.dataset.size);
        applyStyle();
    });
});

// ── Undo / Redo ───────────────────────────────────────────────────────
document.getElementById('undoBtn').addEventListener('click', undo);
document.getElementById('redoBtn').addEventListener('click', redo);

// ── Clear ─────────────────────────────────────────────────────────────
document.getElementById('clearBtn').addEventListener('click', () => {
    saveHistory(); fillBg();
});

// ── Save ──────────────────────────────────────────────────────────────
document.getElementById('saveBtn').addEventListener('click', () => {
    const a = document.createElement('a');
    a.download = `lavagna-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.png`;
    a.href = canvas.toDataURL('image/png');
    a.click();
});

// ── Touch mode ────────────────────────────────────────────────────────
document.getElementById('touchBtn').addEventListener('click', () => {
    touchMode = !touchMode;
    document.getElementById('touchBtn').classList.toggle('active', touchMode);
});

// ── Keyboard shortcuts ────────────────────────────────────────────────
document.addEventListener('keydown', e => {
    const meta = e.metaKey || e.ctrlKey;
    if (meta && e.key === 'z') { e.preventDefault(); e.shiftKey ? redo() : undo(); return; }
    if (meta && e.key === 'y') { e.preventDefault(); redo(); return; }
    if (meta && e.key === 'k') { e.preventDefault(); document.getElementById('clearBtn').click(); return; }
    if (meta && e.key === 's') { e.preventDefault(); document.getElementById('saveBtn').click(); return; }
    if (!meta) {
        const map = { p:'pen', l:'line', a:'arrow', o:'ellipse', r:'rect', e:'eraser' };
        if (map[e.key.toLowerCase()]) setTool(map[e.key.toLowerCase()]);
        if (e.key === '1') document.querySelector('[data-size="3"]').click();
        if (e.key === '2') document.querySelector('[data-size="8"]').click();
        if (e.key === '3') document.querySelector('[data-size="20"]').click();
    }
});

// ── Init ──────────────────────────────────────────────────────────────
window.addEventListener('resize', resizeCanvas);
resizeCanvas();
</script>
</body>
</html>
